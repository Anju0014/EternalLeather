
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src='https://kit.fontawesome.com/fc2e75786e.js' crossorigin='anonymous'></script>
    <link href="https://fonts.googleapis.com/css2?family=Sevillana&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        /* Add your custom styles here */
        #cropperContainer img {
            max-width: 100%;
        }
        #croppedImagesContainer img {
            max-width: 100px;
            margin: 10px;
        }
        .box-brown {
            /* background-image: #e3c7b4; */
            background-image: linear-gradient(to right,#FFE0CA, #964820)
        }
        .box-dash{
            background-image: linear-gradient(#FFE0CA, #bc6438)

        }
        .text-brown {
            color: #250201; /* Brown color */
        }
         .sevillana-title {
            font-family: 'Sevillana', cursive;
            font-size: 2.5em;
            text-align: center;
            margin-top: 10px;
        }
        .box-foot
        {   
            background-color:#964820
        }
    </style>
</head>
<body>
    <%- include('adminheader') %> 
    <div class="flex justify-normal">
        <div class="flex justify-normal">
            <%- include('adminsidebar') %> 
            <br>
        </div> 

        <div class="flex-grow bg-red-100 lg:m-24 sm:m-5 border-2 border-red-950 rounded-2xl w-full">
            <form id="form" action="" method="POST" enctype="multipart/form-data" class="lg:mx-56 lg:my-10 sm:mx-6 sm:my-2">
                <div id="error" class="text-red-900"></div>
                
                <% if (message.error) { %>
                    <div class="text-center bg-red-500 text-white rounded mb-4 mx-10"><%= message.error %></div>
                <% } %>
                
                <% if (message.success) { %>
                    <div class="text-center bg-green-700 text-white rounded mb-4 mx-10"><%= message.success %></div>
                <% } %> 

                <!-- Product Fields -->

                <input type="hidden" name="id" value="<%= product._id %>" >
                <div class="mb-4">
                    <label class="block font-bold mb-2">Product Name</label>
                    <input type="text" id="productname" name="productname" value="<%= product.productName %>" class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <!-- <div class="mb-4">
                    <label class="block font-bold mb-2">Added Date</label>
                    <input type="date" id="adddate" name="adddate" value="<%= product.addDate %>" class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div> -->
                <div class="mb-4">
                    <label class="block font-bold mb-2">Price</label>
                    <input type="number" id="price" name="price" value="<%= product.productPrice %>" class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block font-bold mb-2">Product Stock</label>
                    <input type="number" id="qty" name="qty" value="<%= product.productQuantity %>"  class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block font-bold mb-2">Type</label>
                    <input type="text" id="variety" name="variety" value="<%= product.productType %>" class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block font-bold mb-2">Color</label>
                    <input type="text" id="color" name="color" value="<%= product.productColor %>" class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block font-bold mb-2">Discount</label>
                    <input type="number" id="discount" name="discount"  value="<%= product.productDiscount %>" class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>

                <!-- <div class="mb-4">
                    <label class="block font-bold mb-2">Product Category</label>
                     <select name="category" id="category" class="w-full px-4 py-2 rounded-lg text-black border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value=" " selected disabled>Select a category</option>
                        <% productCollection.forEach((category)=> { %>
                            <option value="<%= category._id %>">
                                <%= category.categoryName %>
                            </option>
                            <% }) %>
                    </select>
                </div> -->
           
                <div class="mb-4">
                    <label class="block font-bold mb-2">Product Category</label>
                    <select name="category" id="category" class="w-full px-4 py-2 rounded-lg text-black border focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="" selected disabled>Select a category</option>
                        <% productCollection.forEach((category) => { %>
                            <option value="<%= category._id %>" <%= category._id.equals(selectedCategoryId) ? 'selected' : '' %>>
                                <%= category.categoryName %>
                            </option>
                        <% }) %>
                    </select>
                </div> 
                 

               
                <div class="mb-4">
                    <label class="block font-bold mb-2">Product Description</label>
                    <textarea id="description" name="description" rows="4"  class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" required><%= product.productDescription %></textarea>
                </div>
                <div class="mb-4">
                    <label class="block font-bold mb-2">Product Images</label>
                    <div class="flex flex-wrap">
                        <% if (product.productImages && product.productImages.length > 0) { %>
                            <% product.productImages.forEach(imageUrl => { %>
                                <div class="relative m-2">
                                    <img src="<%= imageUrl %>" alt="Product Image" class="w-20 h-20">
                                    <!-- Checkbox for marking image to delete, no 'X' -->
                                    <input type="checkbox" name="deleteImages" value="<%= imageUrl %>" class="absolute top-0 right-0 mt-2 mr-2">
                                </div>
                            <% }) %>
                        <% } %>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block font-bold mb-2">Add Images</label>
                    <input type="file" id="images" name="images" multiple class="w-full px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>  
                <div id="cropperContainer" style="display: none; margin-bottom: 20px;">
                    <img id="image" src="" alt="Image for cropping">
                </div>
                <div id="croppedImagesContainer" class="mb-4">
                    <h3 class="text-sm font-medium text-gray-700">Cropped Images</h3>
                    <div id="croppedImages" class="flex flex-wrap"></div>
                </div>
                <!-- <input type="hidden" name="croppedImages" value="url"> -->
                <button type="button" id="cropButton" style="display: none;" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">Crop & Upload</button>

                <button type="submit" id="submitButton" class="w-full bg-black text-white mt-4 font-bold py-2 px-4 rounded-lg">
                    Update Product
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
    const cloudinaryPreset = "ml_defaulteternal";  // Replace with your Cloudinary preset
    const cloudinaryUrl = 'https://api.cloudinary.com/v1_1/dihyb66hn/image/upload'; // Replace with your Cloudinary URL



let cropper;
const inputImage = document.getElementById('images');
const image = document.getElementById('image');
const cropButton = document.getElementById('cropButton');
const cropperContainer = document.getElementById('cropperContainer');
const croppedImagesContainer = document.getElementById('croppedImages');
const form = document.getElementById('form');

// Array to store the URLs of all cropped images
const croppedImageUrls = [];


function validateForm() {
        let isValid = true;
        let errorMessages = [];

        // Get form field values
        const productName = form.productname.value.trim();
        const price = form.price.value.trim();
        const qty = form.qty.value.trim();
        const variety = form.variety.value.trim();
        const color = form.color.value.trim();
        const discount = form.discount.value.trim();
        const category = form.category.value;

        // 2. Add validation checks for each field

        // Validate Product Name
        if (productName.length < 3) {
            errorMessages.push('Product name must be at least 3 characters.');
            isValid = false;
        }

        // Validate Price
        if (!price || isNaN(price) || price <= 0) {
            errorMessages.push('Price must be a positive number.');
            isValid = false;
        }

        // Validate Quantity
        if (!qty || isNaN(qty) || qty < 0) {
            errorMessages.push('Stock must be a positive integer.');
            isValid = false;
        }

        // Validate Type (Variety)
        if (variety.length < 1) {
            errorMessages.push('Product variety is required.');
            isValid = false;
        }

        // Validate Color
        if (color.length < 1) {
            errorMessages.push('Color is required.');
            isValid = false;
        }

        // Validate Discount
        if (!discount || isNaN(discount) || discount < 0 || discount > 100) {
            errorMessages.push('Discount must be between 0 and 100.');
            isValid = false;
        }

        // Validate Category
        if (!category) {
            errorMessages.push('Please select a product category.');
            isValid = false;
        }

        // 3. Display error messages if validation fails
        const errorDiv = document.getElementById('error');
        errorDiv.innerHTML = ''; // Clear any previous errors

        if (!isValid) {
            errorMessages.forEach(msg => {
                const errorMessage = document.createElement('p');
                errorMessage.textContent = msg;
                errorMessage.classList.add('text-red-500'); // Add styles to errors
                errorDiv.appendChild(errorMessage);
            });
        }

        return isValid;
    }
// Handle image file input change
inputImage.addEventListener('change', (event) => {
    const files = event.target.files;
    if (files && files.length > 0) {
        cropperContainer.style.display = 'none';
        cropButton.style.display = 'none';
        croppedImagesContainer.innerHTML = ''; // Clear previous cropped images

        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                image.src = e.target.result;
                cropperContainer.style.display = 'block';
                cropButton.style.display = 'inline-block';
                
                // Destroy previous cropper instance if it exists
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, {
                    aspectRatio: NaN,
                    viewMode: 1,
                    dragMode: 'move',
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                });

                // Handle the cropping and uploading process
                cropButton.onclick = async () => {
                    if (!cropper) {
                        alert('Please select an image first.');
                        return;
                    }

                    cropper.getCroppedCanvas().toBlob(async (blob) => {
                        const formData = new FormData();
                        formData.append('file', blob);
                        formData.append('upload_preset', cloudinaryPreset);

                        try {
                            const response = await fetch(cloudinaryUrl, { method: 'POST', body: formData });
                            const data = await response.json();
                            if (data.secure_url) {
                                const url = data.secure_url;

                                croppedImageUrls.push(url); // Store URL

                                // Display the image
                                const imgElement = document.createElement('img');
                                imgElement.src = url;
                                imgElement.style.maxWidth = '100px';
                                imgElement.style.margin = '10px';
                                croppedImagesContainer.appendChild(imgElement);

                                // Add hidden input for the cropped image URL
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = 'croppedImages';
                                hiddenInput.value = url;
                                form.appendChild(hiddenInput);

                                // Hide cropper and reset
                                cropperContainer.style.display = 'none';
                                cropButton.style.display = 'none';
                                inputImage.value = ''; // Clear file input
                            } else {
                                alert('Failed to upload image to Cloudinary');
                            }
                        } catch (error) {
                            console.error('Error uploading image:', error);
                            alert('Failed to upload image to Cloudinary');
                        }
                    }, 'image/png');
                };
            };
            reader.readAsDataURL(file); // Load the image file into the cropper
        });
    }
});

// Handle form submission
document.getElementById('submitButton').addEventListener('click', async (e) => {
    e.preventDefault();

    if (!validateForm()) {
            return; // Stop submission if validation fails
        }
        
    const formData = new FormData(form);

    // Collect checked checkboxes for deletion
    const checkboxes = document.querySelectorAll('input[name="deleteImages"]:checked');
    const deleteImages = Array.from(checkboxes).map(cb => cb.value);

    if (deleteImages.length > 0) {
        console.log("Images to be deleted:", deleteImages);

        // Add hidden inputs for deleteImages
        deleteImages.forEach(url => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deleteImages';
            input.value = url;
            form.appendChild(input);
        });
    }
    
    // Add cropped images to formData
    croppedImageUrls.forEach(url => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'croppedImages';
        hiddenInput.value = url;
        form.appendChild(hiddenInput);
    });

    // Create the payload
    const jsonPayload = {
        productname: formData.get('productname'),
        price: formData.get('price'),
        description: formData.get('description'),
        qty: formData.get('qty'),
        category: formData.get('category'),
        id: formData.get('id'),
        variety:formData.get('variety'),
        discount:formData.get('discount'),
        color:formData.get('color'),
        croppedImages: croppedImageUrls, // Include the array of cropped image URLs
        deleteImages // Include the array of deleted image URLs
    };

    try {
        const response = await fetch('/admin/product/edit', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jsonPayload),
        });

        const result = await response.json();
        console.log(result);

        if (result.error) {
            document.getElementById('error').textContent = result.error;
        } else {
            window.location.reload();
        }
    } catch (error) {
        console.error('Error submitting form:', error);
    }
});


    </script>
</body>
</html>
